import unittest
import os
from unittest.mock import patch, MagicMock
import pandas as pd
from malware_analyzer import MalwareAnalyzer

class TestMalwareAnalyzer(unittest.TestCase):
    """
    Unit tests for MalwareAnalyzer class
    """
    
    def setUp(self):
        # Create an instance of the tested class with a temporary output file
        self.test_output_file = "test_malware_analysis.xlsx"
        self.analyzer = MalwareAnalyzer(self.test_output_file)
    
    def tearDown(self):
        # Delete temporary files created during tests
        if os.path.exists(self.test_output_file):
            os.remove(self.test_output_file)
        
        if os.path.exists("severity_by_type.png"):
            os.remove("severity_by_type.png")
    
    def test_init(self):
        # Test class initialization
        self.assertEqual(self.analyzer.output_file, self.test_output_file)
        self.assertEqual(self.analyzer.malware_data, [])
    
    def test_add_malware_entry(self):
        # Test adding a malware entry
        self.analyzer.add_malware_entry(
            organization="TestOrg",
            discovery_date="2025-05-01",
            malware_type="Ransomware",
            severity=8
        )
        
        # Check that the entry was added correctly
        self.assertEqual(len(self.analyzer.malware_data), 1)
        entry = self.analyzer.malware_data[0]
        self.assertEqual(entry["organization"], "TestOrg")
        self.assertEqual(entry["discovery_date"], "2025-05-01")
        self.assertEqual(entry["malware_type"], "Ransomware")
        self.assertEqual(entry["severity"], 8)
    
    def test_generate_sample_data(self):
        # Test sample data generation
        self.analyzer.generate_sample_data()
        
        # Check that data was created
        self.assertGreater(len(self.analyzer.malware_data), 0)
        
        # Check data structure
        for entry in self.analyzer.malware_data:
            self.assertIn("organization", entry)
            self.assertIn("discovery_date", entry)
            self.assertIn("malware_type", entry)
            self.assertIn("severity", entry)
    
    @patch('pandas.DataFrame.to_excel')
    @patch('pandas.ExcelWriter')
    def test_create_excel_report(self, mock_excel_writer, mock_to_excel):
        # Add sample data
        self.analyzer.add_malware_entry("TestOrg1", "2025-05-01", "Ransomware", 8)
        self.analyzer.add_malware_entry("TestOrg2", "2025-05-02", "Trojan", 6)
        self.analyzer.add_malware_entry("TestOrg1", "2025-05-03", "Spyware", 5)
        
        # Mock for ExcelWriter context manager
        mock_context = MagicMock()
        mock_excel_writer.return_value.__enter__.return_value = mock_context
        
        # Run the tested function
        self.analyzer.create_excel_report()
        
        # Check that the correct functions were called
        mock_excel_writer.assert_called_once_with(self.test_output_file, engine='openpyxl')
        
        # Check that to_excel was called at least 3 times (for 3 sheets)
        self.assertGreaterEqual(mock_to_excel.call_count, 3)
    
    @patch('pandas.DataFrame.groupby')
    @patch('matplotlib.pyplot.figure')
    @patch('matplotlib.pyplot.savefig')
    @patch('matplotlib.pyplot.close')
    def test_plot_severity_by_type(self, mock_close, mock_savefig, mock_figure, mock_groupby):
        # Add sample data
        self.analyzer.add_malware_entry("TestOrg1", "2025-05-01", "Ransomware", 8)
        self.analyzer.add_malware_entry("TestOrg2", "2025-05-02", "Trojan", 6)
        self.analyzer.add_malware_entry("TestOrg1", "2025-05-03", "Spyware", 5)
        
        # Set up mock for groupby
        mock_group = MagicMock()
        mock_group.mean.return_value = pd.Series([8, 6, 5], index=["Ransomware", "Trojan", "Spyware"])
        mock_groupby.return_value = mock_group
        
        # Run the tested function
        test_output_file = "test_severity_by_type.png"
        self.analyzer.plot_severity_by_type(test_output_file)
        
        # Check that the correct functions were called
        # Check that the figure function was called at least once
        self.assertTrue(mock_figure.called)
        mock_savefig.assert_called_once_with(test_output_file)
        mock_close.assert_called_once()


if __name__ == "__main__":
    unittest.main()